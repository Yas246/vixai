# üöÄ vixai

[![npm version](https://badge.fury.io/js/vixai.svg)](https://badge.fury.io/js/vixai)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![TypeScript](https://img.shields.io/badge/TypeScript-007ACC?logo=typescript&logoColor=white)](https://www.typescriptlang.org/)
[![Node.js](https://img.shields.io/badge/Node.js-43853D?logo=node.js&logoColor=white)](https://nodejs.org/)

**Assistant SQL aliment√© par l'IA** - Transformez vos questions en langage naturel en requ√™tes SQL optimis√©es et s√©curis√©es.

**‚ú® Fonctionnalit√©s principales :**

- ü§ñ **IA Avanc√©e** : Google Gemini 2.0-flash pour g√©n√©ration intelligente de SQL
- üóÑÔ∏è **Bases de donn√©es** : Support complet de SQLite, PostgreSQL, MySQL, MariaDB
- üîç **D√©tection Auto** : D√©tection automatique du type de base de donn√©es
- üõ°Ô∏è **S√©curit√©** : Validation stricte des requ√™tes (SELECT uniquement)
- ‚ö° **Performance** : Syst√®me de fallback et connexions optimis√©es
- üìä **M√©triques** : Suivi d√©taill√© des performances et diagnostics
- üéØ **TypeScript** : Typage complet et IntelliSense
- üîß **Modulaire** : Architecture extensible et maintenable

## üì¶ Installation

### Pr√©requis

- **Node.js** >= 16.0.0
- **npm** ou **yarn**
- **Cl√© API Google Gemini** (obtenir sur [Google AI Studio](https://makersuite.google.com/app/apikey))

### Installation du package

```bash
npm install vixai
# ou
yarn add vixai
```

### Installation des drivers de base de donn√©es

```bash
# PostgreSQL
npm install pg

# MySQL/MariaDB
npm install mysql2

# SQLite (inclus par d√©faut)
```

## ‚öôÔ∏è Configuration

### 1. Variables d'environnement

Cr√©ez un fichier `.env` √† la racine de votre projet :

```env
# üîë API Google Gemini (obligatoire)
GOOGLE_API_KEY=votre_cle_api_google_gemini

# üóÑÔ∏è Option 1 : URL de connexion directe (recommand√©)
DATABASE_URL=postgresql://user:password@localhost:5432/database

# üóÑÔ∏è Option 2 : Configuration d√©taill√©e
DB_TYPE=postgresql
DB_USER=user
DB_PASSWORD=password
DB_HOST=localhost
DB_PORT=5432
DB_NAME=database

# üóÑÔ∏è Option 3 : SQLite (simple)
DATABASE_URL=sqlite:///:memory:
# ou
DB_TYPE=sqlite
DB_PATH=./database.db
```

### 2. Configuration TypeScript

#### Configuration simple (recommand√©e)

```typescript
import { SQLAssistant } from "vixai";

const assistant = new SQLAssistant({
  googleApiKey: process.env.GOOGLE_API_KEY!,
  databaseUrl: process.env.DATABASE_URL!,
});
```

#### Configuration avanc√©e

```typescript
import { SQLAssistant } from "vixai";

const assistant = new SQLAssistant({
  googleApiKey: process.env.GOOGLE_API_KEY!,
  dbType: "postgresql", // Optionnel : d√©tect√© automatiquement
  dbConfig: {
    user: process.env.DB_USER!,
    password: process.env.DB_PASSWORD!,
    host: process.env.DB_HOST!,
    port: parseInt(process.env.DB_PORT!),
    database: process.env.DB_NAME!,
  },
  temperature: 0.1, // Cr√©ativit√© de l'IA (0.0-1.0)
  maxResults: 100, // Nombre max de r√©sultats
});
```

#### Configuration avec initialisation explicite

```typescript
const assistant = new SQLAssistant({
  googleApiKey: process.env.GOOGLE_API_KEY!,
  databaseUrl: process.env.DATABASE_URL!,
});

// Initialisation asynchrone (recommand√©e)
await assistant.initialize();
```

## üöÄ Utilisation

### API Simple (recommand√©e)

```typescript
import { SQLAssistant } from "vixai";

async function example() {
  // Configuration
  const assistant = new SQLAssistant({
    googleApiKey: process.env.GOOGLE_API_KEY!,
    databaseUrl: process.env.DATABASE_URL!,
  });

  // Initialisation (optionnel mais recommand√©)
  await assistant.initialize();

  // Ex√©cution d'une requ√™te
  const result = await assistant.query("Quel client a le plus grand salaire ?");

  if (result.success) {
    console.log("Requ√™te SQL g√©n√©r√©e:", result.query);
    console.log("R√©sultats:", result.data);
  } else {
    console.error("Erreur:", result.error);
  }

  // Fermeture de la connexion
  await assistant.disconnect();
}
```

### API Avanc√©e avec Cha√Æne de Traitement

```typescript
import { SQLAssistant } from "vixai";

async function advancedExample() {
  const assistant = new SQLAssistant({
    googleApiKey: process.env.GOOGLE_API_KEY!,
    databaseUrl: process.env.DATABASE_URL!,
  });

  await assistant.initialize();

  // Utilisation de la cha√Æne compl√®te pour plus de d√©tails
  const result = await assistant.processQuery({
    question: "Montre-moi les 5 clients les plus r√©cents",
    context: "Analyse des nouveaux clients",
  });

  if (result.success) {
    console.log("üìä R√©sultats d√©taill√©s:");
    console.log("- Requ√™te SQL:", result.sqlQuery);
    console.log("- Nombre de r√©sultats:", result.rawData?.length);
    console.log("- Temps d'ex√©cution:", result.executionTime, "ms");
    console.log(
      "- Taux de r√©ussite:",
      (result.steps.filter((s) => s.success).length / result.steps.length) *
        100,
      "%"
    );

    // R√©ponse format√©e
    console.log("\nüìÑ R√©ponse format√©e:");
    console.log(result.formattedResponse);
  }

  await assistant.disconnect();
}
```

### Int√©gration Next.js

#### API Route (`pages/api/query.ts` ou `app/api/query/route.ts`)

```typescript
import { NextRequest, NextResponse } from "next/server";
import { SQLAssistant } from "vixai";

export async function POST(request: NextRequest) {
  try {
    const { question } = await request.json();

    const assistant = new SQLAssistant({
      googleApiKey: process.env.GOOGLE_API_KEY!,
      databaseUrl: process.env.DATABASE_URL!,
    });

    await assistant.initialize();

    const result = await assistant.processQuery({ question });
    await assistant.disconnect();

    if (result.success) {
      return NextResponse.json({
        success: true,
        data: result.rawData,
        sqlQuery: result.sqlQuery,
        formattedResponse: result.formattedResponse,
        executionTime: result.executionTime,
      });
    } else {
      return NextResponse.json(
        {
          success: false,
          error: result.error,
        },
        { status: 400 }
      );
    }
  } catch (error) {
    console.error("Erreur API:", error);
    return NextResponse.json(
      {
        success: false,
        error: "Erreur interne du serveur",
      },
      { status: 500 }
    );
  }
}
```

#### Composant React

```tsx
"use client";

import { useState } from "react";

export default function SQLQueryForm() {
  const [question, setQuestion] = useState("");
  const [result, setResult] = useState<any>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!question.trim()) return;

    setLoading(true);
    setError(null);

    try {
      const response = await fetch("/api/query", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question }),
      });

      const data = await response.json();

      if (data.success) {
        setResult(data);
      } else {
        setError(data.error);
      }
    } catch (err) {
      setError("Erreur de connexion");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="max-w-4xl mx-auto p-6">
      <h1 className="text-3xl font-bold mb-6">Assistant SQL IA</h1>

      <form onSubmit={handleSubmit} className="mb-6">
        <div className="flex gap-2">
          <input
            type="text"
            value={question}
            onChange={(e) => setQuestion(e.target.value)}
            placeholder="Posez votre question en langage naturel..."
            className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            disabled={loading}
          />
          <button
            type="submit"
            disabled={loading || !question.trim()}
            className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {loading ? "üîÑ Recherche..." : "üîç Rechercher"}
          </button>
        </div>
      </form>

      {error && (
        <div className="mb-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">
          ‚ùå {error}
        </div>
      )}

      {result && (
        <div className="space-y-4">
          <div className="p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg">
            ‚úÖ Requ√™te ex√©cut√©e avec succ√®s en {result.executionTime}ms
          </div>

          <div className="bg-gray-100 p-4 rounded-lg">
            <h3 className="font-semibold mb-2">üìù Requ√™te SQL g√©n√©r√©e :</h3>
            <code className="block bg-gray-800 text-green-400 p-3 rounded text-sm overflow-x-auto">
              {result.sqlQuery}
            </code>
          </div>

          <div className="bg-blue-50 p-4 rounded-lg">
            <h3 className="font-semibold mb-2">üìä R√©sultats :</h3>
            <pre className="text-sm overflow-x-auto">
              {JSON.stringify(result.data, null, 2)}
            </pre>
          </div>

          {result.formattedResponse && (
            <div className="bg-purple-50 p-4 rounded-lg">
              <h3 className="font-semibold mb-2">üìÑ R√©ponse format√©e :</h3>
              <div className="prose prose-sm max-w-none">
                {result.formattedResponse.split("\n").map((line, i) => (
                  <p key={i} className="mb-1">
                    {line}
                  </p>
                ))}
              </div>
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

### Exemples de Requ√™tes

```typescript
// Requ√™tes simples
await assistant.query("Combien y a-t-il de clients ?");
await assistant.query("Liste des produits en stock");
await assistant.query("Quel est le montant total des ventes ?");

// Requ√™tes complexes
await assistant.query("Montre-moi les 10 clients les plus actifs ce mois-ci");
await assistant.query("Quels produits n'ont pas √©t√© vendus depuis 6 mois ?");
await assistant.query("Calcule le panier moyen par cat√©gorie");

// Requ√™tes avec jointures
await assistant.query("Liste des commandes avec les informations clients");
await assistant.query("Produits les plus vendus par cat√©gorie");
```

## üóÑÔ∏è Bases de donn√©es support√©es

| Base de donn√©es | Statut         | Driver   | D√©tection auto | Remarques                           |
| --------------- | -------------- | -------- | -------------- | ----------------------------------- |
| **SQLite**      | ‚úÖ **Complet** | Inclus   | ‚úÖ             | Base de donn√©es fichier locale      |
| **PostgreSQL**  | ‚úÖ **Complet** | `pg`     | ‚úÖ             | Support complet des fonctionnalit√©s |
| **MySQL**       | ‚úÖ **Complet** | `mysql2` | ‚úÖ             | Compatible MariaDB                  |
| **MariaDB**     | ‚úÖ **Complet** | `mysql2` | ‚úÖ             | Utilise le driver MySQL             |

### Exemples d'URLs de connexion

```typescript
// SQLite
const sqliteUrl = "sqlite:///:memory:"; // En m√©moire
const sqliteFile = "sqlite:///path/to/database.db"; // Fichier

// PostgreSQL
const postgresUrl = "postgresql://user:password@localhost:5432/database";

// MySQL/MariaDB
const mysqlUrl = "mysql://user:password@localhost:3306/database";
```

## üìö API Reference

### Classe `SQLAssistant`

#### Constructeur

```typescript
new SQLAssistant(options: SQLAssistantOptions)
```

#### M√©thodes principales

##### `initialize(): Promise<void>`

Initialise la connexion √† la base de donn√©es de mani√®re asynchrone.

```typescript
await assistant.initialize();
```

##### `query(question: string): Promise<QueryResult>`

Ex√©cute une requ√™te simple et retourne les r√©sultats bruts.

```typescript
const result = await assistant.query("Combien de clients ?");
// Retourne: { success: boolean, data?: any, query?: string, error?: string }
```

##### `processQuery(input: QueryInput): Promise<ChainResult>`

Ex√©cute une requ√™te avec la cha√Æne de traitement compl√®te et m√©triques.

```typescript
const result = await assistant.processQuery({
  question: "Liste des clients",
  context: "Analyse client√®le",
});
// Retourne: r√©ponse format√©e + m√©triques + tra√ßabilit√©
```

##### `disconnect(): Promise<void>`

Ferme proprement la connexion √† la base de donn√©es.

```typescript
await assistant.disconnect();
```

### Types TypeScript

#### `SQLAssistantOptions`

```typescript
interface SQLAssistantOptions {
  googleApiKey: string; // Cl√© API Google Gemini (obligatoire)
  databaseUrl?: string; // URL de connexion compl√®te
  dbType?: DatabaseType; // Type de BDD (optionnel, auto-d√©tect√©)
  dbConfig?: {
    // Configuration d√©taill√©e
    user?: string;
    password?: string;
    host?: string;
    port?: string | number;
    database?: string;
    filename?: string;
  };
  temperature?: number; // Cr√©ativit√© IA (0.0-1.0, d√©faut: 0.1)
  maxResults?: number; // Limite r√©sultats (d√©faut: 100)
}
```

#### `QueryResult`

```typescript
interface QueryResult {
  success: boolean;
  data?: any; // R√©sultats bruts de la requ√™te
  query?: string; // Requ√™te SQL g√©n√©r√©e
  error?: string; // Message d'erreur si √©chec
}
```

#### `ChainResult`

```typescript
interface ChainResult {
  success: boolean;
  sqlQuery?: string; // Requ√™te SQL g√©n√©r√©e
  rawData?: any; // Donn√©es brutes
  formattedResponse?: string; // R√©ponse format√©e en fran√ßais
  executionTime: number; // Temps d'ex√©cution (ms)
  steps: QueryStep[]; // √âtapes de traitement
  error?: string;
}
```

## üõ°Ô∏è S√©curit√© et bonnes pratiques

### Mesures de s√©curit√©

- ‚úÖ **SELECT uniquement** : Seules les requ√™tes de lecture sont autoris√©es
- ‚úÖ **Validation stricte** : V√©rification de la syntaxe avant ex√©cution
- ‚úÖ **Nettoyage des entr√©es** : Suppression des marqueurs de code et backticks
- ‚úÖ **Limitation des r√©sultats** : Nombre maximum configurable
- ‚úÖ **Connexions s√©curis√©es** : Utilisation de variables d'environnement

### Bonnes pratiques

#### 1. Gestion des connexions

```typescript
// ‚úÖ Bonne pratique : Initialisation explicite
const assistant = new SQLAssistant(config);
await assistant.initialize();

try {
  const result = await assistant.query(question);
} finally {
  await assistant.disconnect(); // Toujours fermer la connexion
}
```

#### 2. Gestion d'erreurs

```typescript
try {
  const result = await assistant.query(question);

  if (!result.success) {
    console.error("Erreur de requ√™te:", result.error);
    // G√©rer l'erreur utilisateur
  } else {
    // Traiter les r√©sultats
    console.log("Donn√©es:", result.data);
  }
} catch (error) {
  console.error("Erreur syst√®me:", error);
  // G√©rer les erreurs syst√®me
}
```

#### 3. Variables d'environnement

```typescript
// ‚úÖ S√©curis√© : Utiliser les variables d'environnement
const assistant = new SQLAssistant({
  googleApiKey: process.env.GOOGLE_API_KEY!,
  databaseUrl: process.env.DATABASE_URL!,
});

// ‚ùå √Ä √©viter : Hardcoder les informations sensibles
const assistant = new SQLAssistant({
  googleApiKey: "AIzaSyAbCdEf...", // Danger !
  databaseUrl: "postgresql://user:secret@localhost/db", // Danger !
});
```

## üîß D√©pannage

### Erreurs communes

#### "API_KEY_INVALID"

```
‚ùå Erreur: API key not valid. Please pass a valid API key.
```

**Solution :**

- V√©rifiez votre cl√© API Google Gemini sur [Google AI Studio](https://makersuite.google.com/app/apikey)
- Assurez-vous que la cl√© n'est pas expir√©e
- V√©rifiez les quotas d'utilisation

#### "Failed to connect to database"

```
‚ùå Erreur: Failed to connect to database
```

**Solutions :**

- V√©rifiez que le serveur de base de donn√©es est d√©marr√©
- V√©rifiez les identifiants de connexion
- V√©rifiez la configuration r√©seau/firewall
- Testez la connexion avec un client SQL

#### "Only SELECT queries are allowed"

```
‚ùå Erreur: Only SELECT queries are allowed
```

**Cause :** Gemini a g√©n√©r√© une requ√™te non-SELECT
**Solution :** Reformulez votre question pour √™tre plus sp√©cifique

### Diagnostic avanc√©

#### Test de connexion

```typescript
// Test basique de connexion
const assistant = new SQLAssistant(config);
await assistant.initialize();

const testResult = await assistant.query("SELECT 1 as test");
if (testResult.success) {
  console.log("‚úÖ Connexion r√©ussie");
} else {
  console.log("‚ùå Probl√®me de connexion:", testResult.error);
}

await assistant.disconnect();
```

## üìä M√©triques et monitoring

### M√©triques disponibles

```typescript
const result = await assistant.processQuery({ question });

console.log("üìà M√©triques de performance:");
console.log(`- Temps total: ${result.executionTime}ms`);
console.log(`- Nombre d'√©tapes: ${result.steps.length}`);
console.log(
  `- Taux de r√©ussite: ${(
    (result.steps.filter((s) => s.success).length / result.steps.length) *
    100
  ).toFixed(1)}%`
);

// D√©tail par √©tape
result.steps.forEach((step, i) => {
  console.log(
    `${i + 1}. ${step.name}: ${step.success ? "‚úÖ" : "‚ùå"} (${step.duration}ms)`
  );
});
```

## ü§ù Contribution

Les contributions sont les bienvenues ! Voici comment contribuer :

### D√©veloppement local

```bash
# Cloner le repository
git clone https://github.com/your-username/vixai.git
cd vixai

# Installer les d√©pendances
npm install

# Build du projet
npm run build

# Lancer les tests
npm test

# Tests avec vraie base de donn√©es
npm run test:integration
```

### Structure du projet

```
src/
‚îú‚îÄ‚îÄ SQLAssistant.ts          # Classe principale
‚îú‚îÄ‚îÄ ConnectionManager.ts     # Gestion des connexions
‚îú‚îÄ‚îÄ PromptManager.ts         # Prompts sp√©cialis√©s
‚îú‚îÄ‚îÄ QueryChain.ts            # Cha√Æne de traitement
‚îú‚îÄ‚îÄ DatabaseTypeDetector.ts  # D√©tection automatique
‚îú‚îÄ‚îÄ config.ts               # Configuration
‚îú‚îÄ‚îÄ types.ts                # Types TypeScript
‚îî‚îÄ‚îÄ index.ts                # Point d'entr√©e

tests/
‚îú‚îÄ‚îÄ unit/                   # Tests unitaires
‚îú‚îÄ‚îÄ integration/            # Tests d'int√©gration
‚îî‚îÄ‚îÄ e2e/                    # Tests end-to-end
```

### Guidelines de contribution

- üîÑ **Fork** le projet
- üåø **Branch** : `feature/nom-de-la-fonctionnalite`
- ‚úÖ **Tests** : Ajouter des tests pour chaque nouvelle fonctionnalit√©
- üìö **Documentation** : Mettre √† jour la documentation
- üéØ **Commits** : Messages clairs et descriptifs
- üì¶ **PR** : Description d√©taill√©e des changements

### Types de contributions

- üêõ **Bug fixes** : Corrections de bugs
- ‚ú® **Features** : Nouvelles fonctionnalit√©s
- üìñ **Documentation** : Am√©liorations de la doc
- üß™ **Tests** : Ajout de tests
- üîß **Performance** : Optimisations
- üé® **UI/UX** : Am√©liorations d'interface

## üìÑ Licence

**MIT License** - Voir le fichier [LICENSE](LICENSE) pour plus de d√©tails.

---

## üôè Remerciements

- **Google Gemini** pour la puissance de l'IA
- **Knex.js** pour l'abstraction de base de donn√©es
- **LangChain** pour l'inspiration architecturale
- **La communaut√© open source** pour les outils et libraries

---

## üìû Support

- üìß **Email** : wabiyassar@gmail.com
- üêõ **Issues** : [GitHub Issues](https://github.com/Yas246/vixai/issues)
- üí¨ **Discussions** : [GitHub Discussions](https://github.com/Yas246/vixai/discussions)

---

**üéâ Merci d'utiliser vixai ! Transformez vos questions en insights puissants.**
